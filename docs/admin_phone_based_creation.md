# 基于手机号的管理员创建功能说明

## 功能概述

品牌管理员和门店管理员的创建已改为基于手机号的方式，简化了用户管理流程。

## 核心特性

### 1. 自动用户创建
- **输入**: 手机号
- **逻辑**: 
  - 如果手机号已注册，直接使用现有用户
  - 如果手机号未注册，系统自动创建新用户
  - 新创建用户的默认密码：`123456`
  - 新创建用户的默认角色：`employer`

### 2. 用户名设置
- 如果提供了`real_name`参数，使用真实姓名作为用户名
- 如果未提供`real_name`，使用手机号作为用户名

## API接口

### 创建品牌管理员

**接口**: `POST /api/v1/admin/brands/admins`

**请求体**:
```json
{
  "phone": "13800138000",
  "brand_id": "1",
  "role_type": "brand_admin",
  "real_name": "张三"  // 可选
}
```

**响应**:
```json
{
  "base": {
    "code": 200,
    "message": "创建品牌管理员成功"
  },
  "role_id": "123"
}
```

### 创建门店管理员

**接口**: `POST /api/v1/admin/stores/admins`

**请求体**:
```json
{
  "phone": "13800138001",
  "brand_id": "1",
  "store_id": "5",
  "real_name": "李四"  // 可选
}
```

**响应**:
```json
{
  "base": {
    "code": 200,
    "message": "创建门店管理员成功"
  },
  "role_id": "124"
}
```

## 业务流程

### 创建品牌管理员流程
1. 根据手机号查询用户
2. 如果用户不存在：
   - 生成密码哈希（默认密码：123456）
   - 设置用户名（real_name或手机号）
   - 创建新用户（角色：employer，状态：active）
3. 验证品牌是否存在
4. 检查用户是否已是该品牌管理员
5. 创建用户角色关联记录
6. 返回成功结果

### 创建门店管理员流程
1. 根据手机号查询用户
2. 如果用户不存在：
   - 生成密码哈希（默认密码：123456）
   - 设置用户名（real_name或手机号）
   - 创建新用户（角色：employer，状态：active）
3. 验证品牌是否存在
4. 验证门店是否存在且属于该品牌
5. 检查用户是否已是该门店管理员
6. 创建用户角色关联记录
7. 返回成功结果

## 错误处理

### 常见错误码

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 500 | 查询用户失败 | 数据库查询错误 |
| 500 | 密码加密失败 | 密码哈希生成失败 |
| 500 | 创建用户失败 | 用户创建失败 |
| 404 | 品牌不存在 | 指定的品牌ID不存在 |
| 404 | 门店不存在 | 指定的门店ID不存在 |
| 400 | 门店不属于该品牌 | 门店的brand_id与请求不匹配 |
| 500 | 检查角色失败 | 角色存在性检查失败 |
| 400 | 该用户已是该品牌的管理员 | 重复分配角色 |
| 400 | 该用户已是该门店的管理员 | 重复分配角色 |
| 500 | 创建品牌管理员失败 | 角色创建失败 |
| 500 | 创建门店管理员失败 | 角色创建失败 |

## 注意事项

1. **默认密码安全性**: 
   - 新创建用户的默认密码为`123456`
   - 建议在首次登录后提示用户修改密码
   - 可以考虑通过短信发送随机密码

2. **手机号唯一性**: 
   - 手机号在系统中是唯一的
   - 一个手机号只能对应一个用户
   - 但一个用户可以有多个管理员角色（不同品牌/门店）

3. **角色权限**: 
   - 新创建的用户基础角色为`employer`
   - 实际权限由`user_roles`表中的记录决定
   - 品牌管理员可以管理该品牌下的所有门店
   - 门店管理员只能管理指定的门店

4. **重复创建检查**: 
   - 系统会检查用户是否已经拥有相同的角色
   - 不允许为同一用户在同一品牌/门店重复分配相同角色

## 使用示例

### 示例1: 创建新用户并分配品牌管理员角色

```bash
curl -X POST http://localhost:8888/api/v1/admin/brands/admins \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "phone": "13800138000",
    "brand_id": "1",
    "role_type": "brand_admin",
    "real_name": "张三"
  }'
```

### 示例2: 为现有用户分配门店管理员角色

```bash
curl -X POST http://localhost:8888/api/v1/admin/stores/admins \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "phone": "13800138000",
    "brand_id": "1",
    "store_id": "5"
  }'
```

## 后续优化建议

1. **密码安全**: 
   - 实现短信验证码注册
   - 支持自定义初始密码
   - 添加密码强度要求

2. **批量操作**: 
   - 支持批量创建管理员
   - Excel导入功能

3. **通知机制**: 
   - 创建成功后发送短信通知
   - 包含登录信息和初始密码

4. **权限细化**: 
   - 支持更细粒度的权限控制
   - 自定义权限模板

