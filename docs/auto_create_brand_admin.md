# 创建品牌时自动开通品牌管理员功能

## 功能概述

在创建品牌时，系统会自动为品牌的联系人开通品牌管理员身份，简化了品牌管理员的创建流程。

## 功能特性

### 1. 自动用户创建

- 根据联系人手机号查询用户
- 如果用户不存在，自动创建新用户
  - 默认密码：`123456`
  - 用户名：使用联系人姓名（如果提供），否则使用手机号
  - 基础角色：`employer`
  - 账号状态：`active`

### 2. 自动角色分配

- 为联系人分配品牌管理员角色（`brand_admin`）
- 关联到刚创建的品牌
- 如果用户已经是该品牌的管理员，跳过角色创建

### 3. 容错处理

- 品牌创建成功后才尝试创建管理员
- 管理员创建失败不影响品牌创建的结果
- 失败时记录详细的日志信息

## 业务流程

```
┌─────────────────────────────────────────┐
│ 管理员创建品牌                          │
│ POST /api/v1/admin/brands               │
│ {                                        │
│   "company_name": "某某公司",           │
│   "contact_person": "张三",             │
│   "contact_phone": "13800138000",       │
│   ...                                    │
│ }                                        │
└────────────┬────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────┐
│ 1. 验证必填字段                         │
│    - contact_person                      │
│    - contact_phone                       │
│    - contact_email                       │
└────────────┬────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────┐
│ 2. 创建品牌记录                         │
│    - 生成品牌ID                         │
│    - 保存品牌信息到数据库               │
└────────────┬────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────┐
│ 3. 为联系人开通品牌管理员身份           │
└────────────┬────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────┐
│ 3.1 根据手机号查询用户                  │
└────────────┬────────────────────────────┘
             │
             ├─→ 用户存在
             │   └─→ 使用现有用户
             │
             └─→ 用户不存在
                 └─→ 创建新用户
                     - 用户名: 联系人姓名 或 手机号
                     - 密码: 123456 (哈希后存储)
                     - 角色: employer
                     - 状态: active
             │
             ▼
┌─────────────────────────────────────────┐
│ 3.2 检查用户是否已是该品牌管理员        │
└────────────┬────────────────────────────┘
             │
             ├─→ 已是管理员
             │   └─→ 跳过角色创建
             │
             └─→ 不是管理员
                 └─→ 创建品牌管理员角色
                     - role_type: brand_admin
                     - brand_id: 新创建的品牌ID
                     - status: active
             │
             ▼
┌─────────────────────────────────────────┐
│ 4. 返回成功响应                         │
│ {                                        │
│   "base": {                              │
│     "code": 200,                         │
│     "message": "品牌创建成功"           │
│   },                                     │
│   "brand_id": "123"                      │
│ }                                        │
└─────────────────────────────────────────┘
```

## 示例场景

### 场景 1: 新联系人

**输入**:
```json
{
  "company_name": "某某科技有限公司",
  "contact_person": "张三",
  "contact_phone": "13800138000",
  "contact_email": "zhangsan@example.com"
}
```

**执行流程**:
1. 创建品牌 → 成功 (brand_id: 123)
2. 查询手机号 `13800138000` → 用户不存在
3. 创建新用户:
   - username: "张三"
   - phone: "13800138000"
   - password_hash: bcrypt("123456")
   - role: "employer"
   - user_id: 456
4. 创建品牌管理员角色:
   - user_id: 456
   - brand_id: 123
   - role_type: "brand_admin"

**结果**:
- 品牌创建成功
- 自动创建了新用户（张三，手机号 13800138000，密码 123456）
- 张三成为该品牌的品牌管理员

### 场景 2: 已存在的联系人

**输入**:
```json
{
  "company_name": "另一家公司",
  "contact_person": "张三",
  "contact_phone": "13800138000",
  "contact_email": "zhangsan@example.com"
}
```

**执行流程**:
1. 创建品牌 → 成功 (brand_id: 789)
2. 查询手机号 `13800138000` → 用户已存在 (user_id: 456)
3. 使用现有用户 (user_id: 456)
4. 创建品牌管理员角色:
   - user_id: 456
   - brand_id: 789
   - role_type: "brand_admin"

**结果**:
- 品牌创建成功
- 使用现有用户（张三）
- 张三成为新品牌的品牌管理员
- 张三现在管理两个品牌（brand_id: 123 和 789）

### 场景 3: 联系人已是该品牌管理员

**输入**:
```json
{
  "company_name": "某某科技有限公司",  // 同一个品牌
  "contact_person": "张三",
  "contact_phone": "13800138000",
  "contact_email": "zhangsan@example.com"
}
```

**执行流程**:
1. 创建品牌 → 成功 (brand_id: 123)
2. 查询手机号 `13800138000` → 用户已存在 (user_id: 456)
3. 检查角色 → 用户已是该品牌管理员
4. 跳过角色创建

**结果**:
- 品牌创建成功
- 检测到张三已是该品牌管理员，不重复创建角色

## 日志记录

系统会记录详细的操作日志：

### 成功日志

```
[INFO] 品牌创建成功, brand_id: 123
[INFO] 为品牌联系人创建用户成功, phone: 13800138000, user_id: 456
[INFO] 创建品牌管理员角色成功, user_id: 456, brand_id: 123, role_id: 789
[INFO] 为联系人开通品牌管理员成功, phone: 13800138000, brand_id: 123
```

### 警告日志（用户已存在）

```
[INFO] 品牌创建成功, brand_id: 123
[INFO] 用户已是该品牌的管理员, user_id: 456, brand_id: 123
[INFO] 为联系人开通品牌管理员成功, phone: 13800138000, brand_id: 123
```

### 错误日志（管理员创建失败）

```
[INFO] 品牌创建成功, brand_id: 123
[WARN] 为联系人开通品牌管理员失败: database error, phone: 13800138000, brand_id: 123
```

**注意**: 即使管理员创建失败，品牌创建仍然是成功的。

## 重要说明

### 1. 密码安全

- 新创建用户的默认密码为 `123456`
- **强烈建议**联系人首次登录后立即修改密码
- 可以考虑通过短信发送初始密码

### 2. 容错设计

管理员创建失败不会回滚品牌创建：
- 品牌创建成功后，管理员创建是独立的操作
- 如果管理员创建失败，可以手动通过"创建品牌管理员"接口补充

### 3. 幂等性

- 多次为同一联系人创建同一品牌的管理员角色，只会创建一次
- 系统会自动检测并跳过重复的角色创建

### 4. 权限范围

新创建的品牌管理员拥有以下权限：
- 查看该品牌的所有信息
- 管理该品牌下的门店
- 管理该品牌下的人员
- 发布和管理该品牌的岗位

## 后续操作建议

### 1. 通知联系人

品牌创建成功后，建议通过短信或邮件通知联系人：

```
尊敬的[联系人姓名]，

您的公司[公司名称]已成功注册为我们平台的品牌。

您的登录信息：
- 手机号：[手机号]
- 初始密码：123456

请尽快登录系统并修改密码。
登录地址：https://admin.example.com

如有问题，请联系客服。
```

### 2. 手动补充管理员

如果自动创建管理员失败，可以手动调用接口：

```bash
POST /api/v1/admin/brands/admins
{
  "phone": "13800138000",
  "brand_id": "123",
  "role_type": "brand_admin",
  "real_name": "张三"
}
```

### 3. 管理员密码重置

如果联系人忘记密码，可以通过"重置密码"接口重置：

```bash
POST /api/v1/admin/users/:user_id/reset-password
```

## 技术实现

### 核心函数

```go
// createBrandAdminForContact 为联系人创建品牌管理员角色
func createBrandAdminForContact(phone, realName string, brandID int64) error
```

### 调用时机

在 `CreateBrandLogic` 函数中，品牌创建成功后立即调用：

```go
// 创建品牌
brandID, err := createBrand(req)
if err != nil {
    return err
}

// 为联系人开通品牌管理员身份
if err := createBrandAdminForContact(req.ContactPhone, req.ContactPerson, brandID); err != nil {
    // 记录警告但不影响品牌创建成功的结果
    utils.Warnf("为联系人开通品牌管理员失败: %v", err)
}
```

### 错误处理

采用"尽力而为"策略：
- 品牌创建成功是主要目标
- 管理员创建失败只记录警告
- 不回滚品牌创建事务

## 测试建议

### 测试用例

1. **新用户创建**
   - 联系人手机号从未注册
   - 验证用户创建成功
   - 验证角色分配成功

2. **已存在用户**
   - 联系人手机号已注册
   - 验证使用现有用户
   - 验证角色分配成功

3. **重复角色**
   - 用户已是该品牌管理员
   - 验证不重复创建角色

4. **容错测试**
   - 模拟用户创建失败
   - 验证品牌创建仍然成功
   - 验证错误日志记录

## 总结

自动创建品牌管理员功能大大简化了品牌入驻流程：

✅ **优点**:
- 一步完成品牌创建和管理员设置
- 减少手动操作，降低出错率
- 提供良好的用户体验

⚠️ **注意**:
- 默认密码需要及时修改
- 失败时需要手动补充管理员
- 需要做好通知工作

